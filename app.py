# ============================================
# ????????? ?????????
# ============================================
!pip install rapidfuzz openpyxl -q

# ============================================
# ???????
# ============================================
import requests
import pandas as pd
from rapidfuzz import fuzz, process
from google.colab import files
import io

# ============================================
# ????????? ??????????? HH
# ============================================
def get_hh_areas():
    """???????? ? ?????? ?????????? ??????? ? HH.ru"""
    print("?? ???????? ?????????? HH.ru...")
    response = requests.get('https://api.hh.ru/areas')
    data = response.json()
    
    areas_dict = {}
    
    def parse_areas(areas, parent_name=""):
        """?????????? ?????? ??? ??????"""
        for area in areas:
            area_id = area['id']
            area_name = area['name']
            
            # ????????? ????? ? ID
            areas_dict[area_name] = {
                'id': area_id,
                'name': area_name,
                'parent': parent_name
            }
            
            # ?????????? ???????????? ????????? ???????
            if area.get('areas'):
                parse_areas(area['areas'], area_name)
    
    parse_areas(data)
    print(f"? ????????? {len(areas_dict)} ??????? ?? ??????????? HH")
    return areas_dict

# ============================================
# ????????????? ???????
# ============================================
def match_cities(client_cities, hh_areas, threshold=80):
    """
    ???????????? ?????? ??????? ?? ???????????? HH
    
    threshold: ??????????? ??????? ?????????? (0-100)
    """
    results = []
    hh_city_names = list(hh_areas.keys())
    
    print(f"\n?? ??????? ????????????? {len(client_cities)} ???????...")
    print(f"?? ????? ??????????: {threshold}%\n")
    
    for client_city in client_cities:
        if pd.isna(client_city) or str(client_city).strip() == "":
            results.append({
                '???????? ????????': client_city,
                '???????? HH': None,
                'ID HH': None,
                '??????': None,
                '?????????? %': 0,
                '??????': '? ?????? ????????'
            })
            continue
        
        client_city = str(client_city).strip()
        
        # ???????? ?????????????
        match = process.extractOne(
            client_city,
            hh_city_names,
            scorer=fuzz.WRatio,
            score_cutoff=threshold
        )
        
        if match:
            matched_name = match[0]
            score = match[1]
            hh_info = hh_areas[matched_name]
            
            status = '? ??????' if score >= 95 else '?? ???????'
            
            results.append({
                '???????? ????????': client_city,
                '???????? HH': hh_info['name'],
                'ID HH': hh_info['id'],
                '??????': hh_info['parent'],
                '?????????? %': round(score, 1),
                '??????': status
            })
        else:
            results.append({
                '???????? ????????': client_city,
                '???????? HH': None,
                'ID HH': None,
                '??????': None,
                '?????????? %': 0,
                '??????': '? ?? ???????'
            })
    
    return pd.DataFrame(results)

# ============================================
# ??????? ???????
# ============================================
def process_client_file(threshold=80):
    """
    ???????? ??????? ?????????
    
    ?????????????? ???????: Excel (.xlsx, .xls), CSV
    """
    print("=" * 60)
    print("?? ????????????? ??????? ? ???????????? HH.RU")
    print("=" * 60)
    
    # ???????? ??????????? HH
    hh_areas = get_hh_areas()
    
    # ???????? ????? ???????
    print("\n?? ????????? ???? ?? ??????? ???????...")
    print("??????: Excel ??? CSV, ?????? ? ?????? ???????")
    uploaded = files.upload()
    
    if not uploaded:
        print("? ???? ?? ????????")
        return
    
    # ?????? ?????
    filename = list(uploaded.keys())[0]
    print(f"\n?? ??????????? ????: {filename}")
    
    try:
        if filename.endswith('.csv'):
            df = pd.read_csv(io.BytesIO(uploaded[filename]))
        else:
            df = pd.read_excel(io.BytesIO(uploaded[filename]))
        
        # ????? ?????? ???????
        client_cities = df.iloc[:, 0].tolist()
        print(f"? ??????? {len(client_cities)} ???????")
        
        # ?????????????
        result_df = match_cities(client_cities, hh_areas, threshold)
        
        # ??????????
        print("\n" + "=" * 60)
        print("?? ??????????:")
        print("=" * 60)
        total = len(result_df)
        exact = len(result_df[result_df['??????'] == '? ??????'])
        similar = len(result_df[result_df['??????'] == '?? ???????'])
        not_found = len(result_df[result_df['??????'] == '? ?? ???????'])
        
        print(f"????? ???????: {total}")
        print(f"? ?????? ??????????: {exact} ({exact/total*100:.1f}%)")
        print(f"?? ???????: {similar} ({similar/total*100:.1f}%)")
        print(f"? ?? ???????: {not_found} ({not_found/total*100:.1f}%)")
        
        # ?????????? ??????
        print("\n" + "=" * 60)
        print("?? ?????? ?????????? (?????? 10 ?????):")
        print("=" * 60)
        print(result_df.head(10).to_string(index=False))
        
        # ?????????? ??????????
        output_filename = f"result_{filename.rsplit('.', 1)[0]}.xlsx"
        result_df.to_excel(output_filename, index=False, engine='openpyxl')
        
        print(f"\n?? ????????? ???????? ?: {output_filename}")
        print("?? ???????? ????...")
        files.download(output_filename)
        
        print("\n? ??????!")
        return result_df
        
    except Exception as e:
        print(f"? ??????: {str(e)}")
        return None

# ============================================
# ??????
# ============================================
# ???????? ??? ??????? ??? ????????? ?????
# ???????? threshold - ??????????? ??????? ?????????? (?? ????????? 80)

result = process_client_file(threshold=80)

# ???? ?????? ???????? ????? ??????????:
# result = process_client_file(threshold=70)  # ????? ?????? ?????
# result = process_client_file(threshold=90)  # ????? ??????? ?????
